<!DOCTYPE html>
<html>

<head>
  <title>Pittsburgh Zillow Properties</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <link rel="stylesheet" type="text/css" href="styles/site.css">
</head>

<body>
    <div class="title">
      <h1>Pittsburgh Zillow Properties</h1>
    </div>

    <div class = "orientation">   
      <svg id="map" height="500" width="500"></svg>
      <div class = "side-panel"> 
        <div id="panel"></div>
      </div>
    </div>


  <script>
    const map = d3.select("svg#map");

    const requestData = async function () {
      const pittsburghMap = await d3.json("data/pittsburgh.json");

      const zillowData = await d3.csv("data/zillow-filtered.csv", d3.autoType);
      console.log(zillowData);
      const mapHeight = map.attr("height");
      const mapWidth = map.attr("width");

      console.log(pittsburghMap);

      let viewport = map.append("g");

      var neighborhoodMesh = topojson.mesh(pittsburghMap, pittsburghMap.objects.pittsburgh)
      var neighborhoods = topojson.feature(pittsburghMap, pittsburghMap.objects.pittsburgh)
      console.log(neighborhoods);
      var proj = d3.geoMercator().fitSize([mapWidth, mapHeight], neighborhoods);
      var path = d3.geoPath().projection(proj);

      viewport.selectAll("path.neighborhood")
              .data(neighborhoods.features)
              .join("path")
              .attr("class", "neighborhood")
              .style("fill", "lightblue")
              .style("stroke", "black")
              .style("stroke-width", "1px")
              .attr("d", path);

    let selectedProperties = []

    //plot points on the map 
    let houses = viewport.selectAll("circle.house")
                         .data(zillowData)
                         .join("circle")
                         .attr("class", "house")
                         .attr("cx", d => proj([d.Longitude, d.Latitude])[0])
                         .attr("cy", d => proj([d.Longitude, d.Latitude])[1])
                         .attr("r", "2px")
                         .attr("note", d => d['Street Address'])
                         .style("fill", "navy") 
                         .on("click", function (event, d)  {
                          console.log(d)
                          var propetySelected = d3.select(this);
                          if (propetySelected.classed("selectedProperty")) {
                            propetySelected.classed("selectedProperty", false);
                            indexP = selectedProperties.indexOf(d)
                            if (selectedProperties.length == 1){
                              selectedProperties = []
                            }
                            else{
                              selectedProperties = selectedProperties.splice(indexP, 1);
                            }

                            propetySelected
                                  .transition()
                                  .duration(500)
                                  .attr("stroke-width", "0px");
                          } else if (selectedProperties.length <2 && !selectedProperties.includes(d)){
                            // console.log(propetySelected)
                            console.log(propetySelected)
                            selectedProperties.push(d)
                            propetySelected.classed("selectedProperty", true);
                            propetySelected
                                .transition()
                                .duration(500)
                                .attr("stroke", "#dba5ff")
                                .attr("stroke-width", "2px");
                          }
                          console.log(propetySelected.classed("selectedProperty"))
                          console.log(selectedProperties)
                          if (selectedProperties.length == 2){
                            // updatePanel(selectedProperties)
                          }
                        })
         
    }


    requestData();
  </script>
</body>
