<!DOCTYPE html>
<html>

<head>
  <title>Pittsburgh Zillow Properties</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <script src="scripts/drawlegend.js"></script>

  <link rel="stylesheet" type="text/css" href="styles/site.css">
</head>

<body>
    <div class="title">
      <h1>Pittsburgh Zillow Properties</h1>
    </div>

    <div class = "orientation">   

      <div class="map-legend">  
        <svg id="map" height="500" width="500"></svg>
        <svg id="barLegend" height="50" width="500"></svg>
      </div>
      <div class = "side-panel"> 
        <!-- <button class = "button" onclick= "reset()" type="button">Reset</button> -->
        <button class = "button" id="resetButton" type="button">Reset</button>


        <div id="panel"></div>
      </div>
    </div>


  <script>
    const map = d3.select("svg#map");
    const bar = d3.select("svg#barLegend");

    const requestData = async function () {
      const pittsburghMap = await d3.json("data/pittsburgh.json");

      const zillowData = await d3.csv("data/zillow-filtered.csv", d3.autoType);
      console.log(zillowData);
      const mapHeight = map.attr("height");
      const mapWidth = map.attr("width");

      console.log(pittsburghMap);

      let viewport = map.append("g");

      var neighborhoodMesh = topojson.mesh(pittsburghMap, pittsburghMap.objects.pittsburgh)
      var neighborhoods = topojson.feature(pittsburghMap, pittsburghMap.objects.pittsburgh)
      console.log(neighborhoods);
      var proj = d3.geoMercator().fitSize([mapWidth, mapHeight], neighborhoods);
      var path = d3.geoPath().projection(proj);
    
      //create pricing bins
      //this can probably be used for the histogram later too!
      let prices = [];
      zillowData.forEach(d => {
        prices.push(d['Sale Amount']);
      });

      let pricingExtent = d3.extent(prices);
      
      let histogram = d3.histogram()
                        .domain(pricingExtent)
                        .thresholds(6); 
      let histogramCounts = histogram(prices);

      // making a color scale that will be used for the legend
      let colorScheme = d3.schemeYlGnBu[9];
      let colorScale = d3.scaleQuantize()
                         .domain(pricingExtent)
                         .range(colorScheme.slice(4, 9));


      // draw legend using external function found in /scripts/drawlegend.js by Prof. Jeff Rz
      drawLegend("svg#barLegend", colorScale);



      viewport.selectAll("path.neighborhood")
              .data(neighborhoods.features)
              .join("path")
              .attr("class", "neighborhood")
              .style("fill", "lightblue")
              .style("stroke", "black")
              .style("stroke-width", "1px")
              .attr("d", path);

      let selectedProperties = [];
      let resetButton = d3.select("#resetButton").on("click", function() {reset()});

      //plot points on the map 
      let houses = viewport.selectAll("circle.house")
                          .data(zillowData)
                          .join("circle")
                          .attr("class", "house")
                          .attr("cx", d => proj([d.Longitude, d.Latitude])[0])
                          .attr("cy", d => proj([d.Longitude, d.Latitude])[1])
                          .attr("r", "3px")
                          .attr("note", d => d['Street Address'])
                          .style("fill", d => colorScale(d['Sale Amount'])) 
                          .on("click", function (event, d)  {
                            console.log("click d", d);
                            var propertySelected = d3.select(this);

                            if (selectedProperties.length <2 && !selectedProperties.includes(d)){
                              // console.log(propertySelected)
                              console.log(propertySelected);
                              selectedProperties.push(d);
                              propertySelected.classed("selectedProperty", true);
                              propertySelected
                                  .transition()
                                  .duration(500)
                                  .attr("stroke", "#dba5ff")
                                  .attr("stroke-width", "2px");
                            }
                            console.log("is this point in selected array", propertySelected.classed("selectedProperty"));
                            console.log("selected properties", selectedProperties);
                            updatePanel([]);

                            if (selectedProperties.length == 2){
                              updatePanel(selectedProperties);
                            }
                          });


      let headers = ["Street Address", "Neighborhood", "Sale Amount","Bathroom", "Bedrooms"];
      let panelTitle = d3.select("#panel").append("h3");
      panelTitle.text("Price Comparison");
      let table = d3.select("#panel").append("table");
      let header = table.selectAll("th")
                        .data(headers)
                        .enter().append("th")
                        .text(function (d) {
                          return d;
                        })
                        .attr("class",
                          function (d) {
                            if (d === "Title") {
                              return "table-title";
                            }
                            else {
                              return "";
                            }
                        });

      function updatePanel(selectedPropertiesList) {
        console.log(selectedPropertiesList)
        header = table.selectAll("th")
          .data(headers)
          .enter().append("th")
          .text(function (d) {
            return d;
          });

        let rows = table.selectAll("tr").data(selectedPropertiesList)
          .join(enter => enter.append("tr"),
            update => update.selectAll("td").remove(),
            exit => exit.remove());

        for (var i = 0; i< headers.length; i++){
          rows.append("td").text(d => d[headers[i]]);
        }
      }    

      function reset() {
        selectedProperties = [];
        console.log("reset properties array", selectedProperties);
        d3.selectAll("circle.house")
          .attr("stroke-width", "0px")
          .classed("selectedProperty", false);
        updatePanel([]);
      }
    }

    requestData();
  </script>
</body>
